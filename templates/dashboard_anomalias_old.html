<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenEnergy Insights - Dashboard de Anomalías</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #2e7d32;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--primary-color);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }

        .stat-card .card-body {
            padding: 1.5rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .anomaly-alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .anomaly-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .anomaly-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .anomaly-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .anomaly-item.critica { border-left-color: var(--danger-color); }
        .anomaly-item.alta { border-left-color: var(--warning-color); }
        .anomaly-item.media { border-left-color: var(--info-color); }
        .anomaly-item.baja { border-left-color: var(--success-color); }

        .severity-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
        }

        .severity-critica { background-color: var(--danger-color); color: white; }
        .severity-alta { background-color: var(--warning-color); color: white; }
        .severity-media { background-color: var(--info-color); color: white; }
        .severity-baja { background-color: var(--success-color); color: white; }

        .filter-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header py-3">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-leaf text-success me-2"></i>
                        GreenEnergy Insights
                        <small class="text-muted">Dashboard de Anomalías</small>
                    </h1>
                </div>
                <div class="col-md-6 text-end">
                    <span class="badge bg-success me-2">
                        <i class="fas fa-circle pulse"></i> En vivo
                    </span>
                    <small class="text-muted" id="lastUpdate">Actualizando...</small>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- Panel de Filtros -->
        <div class="filter-panel">
            <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filtros y Controles</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="fechaInicio">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="fechaFin">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Severidad</label>
                    <select class="form-select" id="filtroSeveridad">
                        <option value="">Todas</option>
                        <option value="critica">Crítica</option>
                        <option value="alta">Alta</option>
                        <option value="media">Media</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="filtroTipo">
                        <option value="">Todos</option>
                        <option value="pico">Pico</option>
                        <option value="valle">Valle</option>
                        <option value="patron_anomalo">Patrón Anómalo</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjetas de Estadísticas -->
        <div class="row g-4 mb-4">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon bg-primary me-3">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <p class="stat-number text-primary" id="totalAnomalias">0</p>
                            <p class="stat-label">Total Anomalías</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon bg-danger me-3">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div>
                            <p class="stat-number text-danger" id="anomaliasCriticas">0</p>
                            <p class="stat-label">Críticas (24h)</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon bg-warning me-3">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <p class="stat-number text-warning" id="tipoMasComun">-</p>
                            <p class="stat-label">Tipo Más Común</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon bg-success me-3">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <p class="stat-number text-success" id="ultimaActualizacion">-</p>
                            <p class="stat-label">Última Actualización</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon bg-info me-3">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div>
                            <p class="stat-number text-info" id="porcentajeCriticas">0%</p>
                            <p class="stat-label">% Críticas</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon bg-secondary me-3">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div>
                            <p class="stat-number text-secondary" id="promedioDiario">0</p>
                            <p class="stat-label">Promedio/Día</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos Principales -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-chart-area me-2"></i>Datos de Energía y Anomalías</h5>
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Distribución por Severidad</h5>
                    <canvas id="severityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Gráficos Secundarios -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Anomalías por Día</h5>
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3"><i class="fas fa-chart-doughnut me-2"></i>Tipos de Anomalías</h5>
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Lista de Anomalías Recientes -->
        <div class="row">
            <div class="col-12">
                <div class="chart-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Anomalías Recientes</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="cargarAnomalias()">
                            <i class="fas fa-sync-alt me-1"></i>Actualizar
                        </button>
                    </div>
                    
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando anomalías...</p>
                    </div>
                    
                    <div class="anomaly-list" id="anomalyList">
                        <!-- Las anomalías se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let charts = {};
        let currentData = {};
        
        // Variables para alertas
        let ultimasAnomaliasCriticas = 0;
        let notificacionesHabilitadas = true;
        
        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFechas();
            cargarDatos();
            solicitarPermisoNotificaciones();
            setInterval(cargarDatos, 30000); // Actualizar cada 30 segundos
        });
        
        function inicializarFechas() {
            const hoy = new Date();
            const hace7dias = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('fechaInicio').value = hace7dias.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
        }
        
        async function cargarDatos() {
            try {
                // Cargar estadísticas
                const statsResponse = await fetch('/api/anomalies/stats');
                const stats = await statsResponse.json();
                actualizarEstadisticas(stats);
                
                // Cargar anomalías
                await cargarAnomalias();
                
                // Cargar datos para gráficos
                const energyResponse = await fetch('/api/energy_data/recent?days=7');
                const energyData = await energyResponse.json();
                
                const anomaliesResponse = await fetch('/api/anomalies?limit=200');
                const anomaliesData = await anomaliesResponse.json();
                
                // Actualizar gráficos
                actualizarGraficos(energyData, anomaliesData, stats);
                
                // Actualizar timestamp
                document.getElementById('lastUpdate').textContent = 
                    `Última actualización: ${new Date().toLocaleString()}`;
                    
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarError('Error al cargar los datos del dashboard');
            }
        }
        
        function actualizarEstadisticas(stats) {
            const totalAnomalias = stats.total_anomalies || 0;
            const anomaliasCriticas = stats.critical_last_24h || 0;
            
            document.getElementById('totalAnomalias').textContent = totalAnomalias;
            document.getElementById('anomaliasCriticas').textContent = anomaliasCriticas;
            
            // Verificar nuevas anomalías críticas
            if (anomaliasCriticas > ultimasAnomaliasCriticas && ultimasAnomaliasCriticas > 0) {
                const nuevas = anomaliasCriticas - ultimasAnomaliasCriticas;
                mostrarAlertaCritica(nuevas);
                enviarNotificacion(`¡${nuevas} nueva(s) anomalía(s) crítica(s) detectada(s)!`);
            }
            ultimasAnomaliasCriticas = anomaliasCriticas;
            
            // Aplicar efectos visuales según severidad
            const tarjetaCriticas = document.getElementById('anomaliasCriticas').closest('.card');
            if (anomaliasCriticas > 0) {
                tarjetaCriticas.classList.add('pulse');
                tarjetaCriticas.style.borderLeft = '4px solid #f44336';
            } else {
                tarjetaCriticas.classList.remove('pulse');
                tarjetaCriticas.style.borderLeft = '';
            }
            
            // Tipo más común
            const tipos = stats.by_type || {};
            const tipoMasComun = Object.keys(tipos).length > 0 ? 
                Object.keys(tipos).reduce((a, b) => tipos[a] > tipos[b] ? a : b) : 'N/A';
            document.getElementById('tipoMasComun').textContent = tipoMasComun;
            
            // Porcentaje de anomalías críticas
            const severidades = stats.by_severity || {};
            const totalSeveridad = Object.values(severidades).reduce((a, b) => a + b, 0);
            const criticasTotal = severidades.critica || 0;
            const porcentajeCriticas = totalSeveridad > 0 ? 
                ((criticasTotal / totalSeveridad) * 100).toFixed(1) : '0';
            document.getElementById('porcentajeCriticas').textContent = porcentajeCriticas + '%';
            
            // Promedio de anomalías por día
            const diasCon = stats.by_day || [];
            const promedioDiario = diasCon.length > 0 ? 
                (diasCon.reduce((sum, day) => sum + day.count, 0) / diasCon.length).toFixed(1) : '0';
            document.getElementById('promedioDiario').textContent = promedioDiario;
            
            // Hora de última actualización
            if (stats.last_update) {
                const fecha = new Date(stats.last_update);
                document.getElementById('ultimaActualizacion').textContent = fecha.toLocaleTimeString();
            }
        }
        
        function solicitarPermisoNotificaciones() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    notificacionesHabilitadas = permission === 'granted';
                });
            } else {
                notificacionesHabilitadas = Notification.permission === 'granted';
            }
        }
        
        function enviarNotificacion(mensaje) {
            if (notificacionesHabilitadas && 'Notification' in window) {
                new Notification('GreenEnergy Insights - Alerta', {
                    body: mensaje,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234caf50"/><path d="M30 50l15 15 25-25" stroke="white" stroke-width="5" fill="none"/></svg>',
                    tag: 'anomaly-alert',
                    requireInteraction: true
                });
            }
        }
        
        function mostrarAlertaCritica(cantidad) {
            // Crear alerta visual en el dashboard
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show anomaly-alert';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-fire me-2 fa-lg"></i>
                    <div>
                        <strong>¡Alerta Crítica!</strong><br>
                        <small>${cantidad} nueva(s) anomalía(s) crítica(s) detectada(s)</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remover después de 10 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 10000);
            
            // Sonido de alerta (opcional)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBDuJ1fLNeSsFJHfH8N2QQAoUXrTp66hVFA==');
                audio.volume = 0.3;
                audio.play().catch(() => {}); // Ignorar errores de audio
            } catch (e) {}
        }
        
        async function cargarAnomalias() {
            const container = document.getElementById('anomalyList');
            const spinner = document.getElementById('loadingSpinner');
            
            try {
                spinner.style.display = 'block';
                
                const params = new URLSearchParams();
                
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                const severidad = document.getElementById('filtroSeveridad').value;
                const tipo = document.getElementById('filtroTipo').value;
                
                if (fechaInicio) params.append('fecha_inicio', fechaInicio);
                if (fechaFin) params.append('fecha_fin', fechaFin);
                if (severidad) params.append('severidad', severidad);
                if (tipo) params.append('tipo', tipo);
                params.append('limit', '50');
                
                const response = await fetch(`/api/anomalies?${params}`);
                const anomalies = await response.json();
                
                container.innerHTML = '';
                
                if (anomalies.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4">No se encontraron anomalías con los filtros aplicados</div>';
                } else {
                    anomalies.forEach(anomaly => {
                        const item = crearItemAnomalia(anomaly);
                        container.appendChild(item);
                    });
                }
                
            } catch (error) {
                console.error('Error cargando anomalías:', error);
                container.innerHTML = '<div class="text-center text-danger py-4">Error al cargar las anomalías</div>';
            } finally {
                spinner.style.display = 'none';
            }
        }
        
        function crearItemAnomalia(anomaly) {
            const div = document.createElement('div');
            div.className = `anomaly-item ${anomaly.severidad}`;
            
            const fecha = new Date(anomaly.timestamp);
            const fechaTexto = fecha.toLocaleString();
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="severity-badge severity-${anomaly.severidad} me-2">
                                ${anomaly.severidad.toUpperCase()}
                            </span>
                            <span class="badge bg-light text-dark">${anomaly.tipo_anomalia}</span>
                        </div>
                        <div class="fw-bold mb-1">Valor: ${anomaly.value.toFixed(2)} GWh</div>
                        <div class="text-muted small">
                            <i class="fas fa-clock me-1"></i>${fechaTexto}
                        </div>
                        <div class="text-muted small">
                            <i class="fas fa-cog me-1"></i>Método: ${anomaly.metodo_deteccion}
                            ${anomaly.score_anomalia ? ` | Score: ${anomaly.score_anomalia.toFixed(3)}` : ''}
                        </div>
                    </div>
                    <div class="ms-3">
                        ${getSeverityIcon(anomaly.severidad)}
                    </div>
                </div>
            `;
            
            return div;
        }
        
        function getSeverityIcon(severidad) {
            const icons = {
                'critica': '<i class="fas fa-fire text-danger fs-4"></i>',
                'alta': '<i class="fas fa-exclamation-triangle text-warning fs-4"></i>',
                'media': '<i class="fas fa-info-circle text-info fs-4"></i>',
                'baja': '<i class="fas fa-check-circle text-success fs-4"></i>'
            };
            return icons[severidad] || '<i class="fas fa-question-circle text-secondary fs-4"></i>';
        }
        
        function aplicarFiltros() {
            cargarAnomalias();
        }
        
        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            document.getElementById('filtroSeveridad').value = '';
            document.getElementById('filtroTipo').value = '';
            inicializarFechas();
            cargarAnomalias();
        }
        
        function mostrarError(mensaje) {
            // Crear toast de error
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-danger border-0';
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-circle me-2"></i>${mensaje}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            // Agregar al DOM y mostrar
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Limpiar después de ocultar
            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toast);
            });
        }
        
        function actualizarGraficos(energyData, anomaliesData, stats) {
            // Gráfico de serie temporal con anomalías
            actualizarGraficoTimeSeries(energyData, anomaliesData);
            
            // Gráfico de distribución por severidad
            actualizarGraficoSeveridad(stats.by_severity || {});
            
            // Gráfico de anomalías por día
            actualizarGraficoDiario(stats.by_day || []);
            
            // Gráfico de tipos de anomalías
            actualizarGraficoTipos(stats.by_type || {});
        }
        
        function actualizarGraficoTimeSeries(energyData, anomaliesData) {
            const ctx = document.getElementById('timeSeriesChart').getContext('2d');
            
            // Preparar datos de energía
            const energyLabels = energyData.map(d => new Date(d.timestamp));
            const energyValues = energyData.map(d => d.demanda);
            
            // Preparar datos de anomalías
            const anomalyPoints = anomaliesData.map(a => ({
                x: new Date(a.timestamp),
                y: a.value,
                severidad: a.severidad,
                tipo: a.tipo_anomalia
            }));
            
            if (charts.timeSeries) {
                charts.timeSeries.destroy();
            }
            
            charts.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: energyLabels,
                    datasets: [
                        {
                            label: 'Demanda Energética (GWh)',
                            data: energyValues,
                            borderColor: 'rgb(46, 125, 50)',
                            backgroundColor: 'rgba(46, 125, 50, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Anomalías Críticas',
                            data: anomalyPoints.filter(p => p.severidad === 'critica'),
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: 'rgb(244, 67, 54)',
                            borderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            showLine: false,
                            type: 'scatter'
                        },
                        {
                            label: 'Anomalías Altas',
                            data: anomalyPoints.filter(p => p.severidad === 'alta'),
                            backgroundColor: 'rgba(255, 152, 0, 0.8)',
                            borderColor: 'rgb(255, 152, 0)',
                            borderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false,
                            type: 'scatter'
                        },
                        {
                            label: 'Otras Anomalías',
                            data: anomalyPoints.filter(p => p.severidad !== 'critica' && p.severidad !== 'alta'),
                            backgroundColor: 'rgba(33, 150, 243, 0.6)',
                            borderColor: 'rgb(33, 150, 243)',
                            borderWidth: 1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            showLine: false,
                            type: 'scatter'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'point',
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString();
                                },
                                label: function(context) {
                                    if (context.dataset.type === 'scatter') {
                                        const point = context.raw;
                                        return `${context.dataset.label}: ${point.y.toFixed(2)} GWh (${point.tipo || ''})`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} GWh`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'MMM DD HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Tiempo'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Demanda (GWh)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function actualizarGraficoSeveridad(bySeverity) {
            const ctx = document.getElementById('severityChart').getContext('2d');
            
            const labels = Object.keys(bySeverity);
            const data = Object.values(bySeverity);
            const colors = {
                'critica': '#f44336',
                'alta': '#ff9800',
                'media': '#2196f3',
                'baja': '#4caf50'
            };
            
            if (charts.severity) {
                charts.severity.destroy();
            }
            
            charts.severity = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(label => colors[label] || '#666'),
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function actualizarGraficoDiario(byDay) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            const labels = byDay.map(d => new Date(d.fecha).toLocaleDateString());
            const data = byDay.map(d => d.count);
            
            if (charts.daily) {
                charts.daily.destroy();
            }
            
            charts.daily = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Anomalías por Día',
                        data: data,
                        backgroundColor: 'rgba(46, 125, 50, 0.8)',
                        borderColor: 'rgb(46, 125, 50)',
                        borderWidth: 2,
                        borderRadius: 5,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Anomalías'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        }
                    }
                }
            });
        }
        
        function actualizarGraficoTipos(byType) {
            const ctx = document.getElementById('typeChart').getContext('2d');
            
            const labels = Object.keys(byType);
            const data = Object.values(byType);
            const colors = ['#2196f3', '#4caf50', '#ff9800', '#f44336', '#9c27b0'];
            
            if (charts.type) {
                charts.type.destroy();
            }
            
            charts.type = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map(l => l.replace('_', ' ').toUpperCase()),
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>